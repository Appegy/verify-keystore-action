name: ci

on:
  push:
    paths-ignore:
      - '**.md'
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - run: npm ci

      - run: npm run build

      - name: verify dist is up to date
        run: |
          git status --porcelain
          git diff --exit-code

  test:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4

      - name: Generate JKS Test Keystore
        id: test_jks
        run: |
          # JKS keystore with different store and key passwords
          keytool -genkeypair \
            -alias test_alias \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore debug.jks \
            -storetype JKS \
            -storepass "store_password" \
            -keypass "key_password" \
            -dname "CN=Test, OU=Test, O=Test, L=Test, S=Test, C=US"
          
          echo "KEYSTORE_BASE64=$(base64 debug.jks -w 0)" >> "$GITHUB_OUTPUT"

      - name: Generate PKCS12 Test Keystore
        id: test_pkcs12
        run: |
          # PKCS12 keystore - must have same password for store and key
          keytool -genkeypair \
            -alias test_alias \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore debug.p12 \
            -storetype PKCS12 \
            -storepass "password123" \
            -keypass "password123" \
            -dname "CN=Test, OU=Test, O=Test, L=Test, S=Test, C=US"
          
          echo "KEYSTORE_BASE64=$(base64 debug.p12 -w 0)" >> "$GITHUB_OUTPUT"

      - name: Generate JKS with Same Passwords
        id: test_jks_same
        run: |
          # JKS keystore where key password = store password
          # User might mistakenly provide different passwords
          keytool -genkeypair \
            -alias test_alias \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore same_pass.jks \
            -storetype JKS \
            -storepass "same_password" \
            -keypass "same_password" \
            -dname "CN=Test, OU=Test, O=Test, L=Test, S=Test, C=US"


      - name: '‚úÖ Test 1: JKS with File Path'
        uses: ./
        with:
          keystore-path: './debug.jks'
          keystore-password: 'store_password'
          alias-name: 'test_alias'
          alias-password: 'key_password'

      - name: '‚úÖ Test 2: JKS with Base64 Input'
        uses: ./
        with:
          keystore-base64: ${{ steps.test_jks.outputs.KEYSTORE_BASE64 }}
          keystore-password: 'store_password'
          alias-name: 'test_alias'
          alias-password: 'key_password'

      - name: '‚úÖ Test 3: PKCS12 with Matching Passwords'
        uses: ./
        with:
          keystore-path: './debug.p12'
          keystore-password: 'password123'
          alias-name: 'test_alias'
          alias-password: 'password123'

      - name: '‚úÖ Test 4: PKCS12 with Base64'
        uses: ./
        with:
          keystore-base64: ${{ steps.test_pkcs12.outputs.KEYSTORE_BASE64 }}
          keystore-password: 'password123'
          alias-name: 'test_alias'
          alias-password: 'password123'

      - name: '‚ùå Test 5: PKCS12 with Different Passwords (should fail)'
        id: test_pkcs12_different_passwords
        continue-on-error: true
        uses: ./
        with:
          keystore-path: './debug.p12'
          keystore-password: 'password123'
          alias-name: 'test_alias'
          alias-password: 'wrong_password'

      - name: Verify Test 5 Failed as Expected
        if: steps.test_pkcs12_different_passwords.outcome != 'failure'
        run: |
          echo "::error::Test 5 should have failed but it passed!"
          exit 1

      - name: '‚ùå Test 6: Wrong Store Password (should fail)'
        id: test_wrong_store_password
        continue-on-error: true
        uses: ./
        with:
          keystore-path: './debug.jks'
          keystore-password: 'wrong_password'
          alias-name: 'test_alias'
          alias-password: 'key_password'

      - name: Verify Test 6 Failed as Expected
        if: steps.test_wrong_store_password.outcome != 'failure'
        run: |
          echo "::error::Test 6 should have failed but it passed!"
          exit 1

      - name: '‚ùå Test 7: Wrong Alias Name (should fail)'
        id: test_wrong_alias
        continue-on-error: true
        uses: ./
        with:
          keystore-path: './debug.jks'
          keystore-password: 'store_password'
          alias-name: 'nonexistent_alias'
          alias-password: 'key_password'

      - name: Verify Test 7 Failed as Expected
        if: steps.test_wrong_alias.outcome != 'failure'
        run: |
          echo "::error::Test 7 should have failed but it passed!"
          exit 1

      - name: '‚ùå Test 8: JKS Wrong Key Password (should fail)'
        id: test_wrong_key_password
        continue-on-error: true
        uses: ./
        with:
          keystore-path: './debug.jks'
          keystore-password: 'store_password'
          alias-name: 'test_alias'
          alias-password: 'wrong_key_password'

      - name: Verify Test 8 Failed as Expected
        if: steps.test_wrong_key_password.outcome != 'failure'
        run: |
          echo "::error::Test 8 should have failed but it passed!"
          exit 1

      - name: '‚ùå Test 9: JKS with Same Passwords but User Provides Different (should fail)'
        id: test_jks_same_pass_mismatch
        continue-on-error: true
        uses: ./
        with:
          keystore-path: './same_pass.jks'
          keystore-password: 'same_password'
          alias-name: 'test_alias'
          alias-password: 'wrong_password'

      - name: Verify Test 9 Failed as Expected
        if: steps.test_jks_same_pass_mismatch.outcome != 'failure'
        run: |
          echo "::error::Test 9 should have failed but it passed!"
          exit 1


      - name: 'üéâ All Tests Passed'
        run: echo "All positive and negative tests completed successfully!"
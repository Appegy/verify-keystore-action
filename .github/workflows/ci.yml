name: ci

on:
  push:
    paths-ignore:
      - '**.md'
  pull_request:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 24
          cache: npm

      - run: npm ci

      - run: npm run build

      - name: verify dist is up to date
        run: |
          git status --porcelain
          git diff --exit-code

  smoke:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 5
    steps:
      - uses: actions/checkout@v4

      - name: Generate Test Keystore
        id: test_data
        run: |
          keytool -genkeypair \
            -alias test_alias \
            -keyalg RSA \
            -keysize 2048 \
            -validity 10000 \
            -keystore debug.keystore \
            -storepass "password123" \
            -keypass "password123" \
            -dname "CN=Test, OU=Test, O=Test, L=Test, S=Test, C=US"
          
          # Create Base64 version
          # Using -w 0 to ensure no newlines on Linux
          echo "KEYSTORE_BASE64=$(base64 debug.keystore -w 0)" >> "$GITHUB_OUTPUT"

      - name: 'Test 1: Using File Path'
        uses: ./
        with:
          keystore-path: './debug.keystore'
          keystore-password: 'password123'
          alias-name: 'test_alias'
          alias-password: 'password123'

      - name: 'Test 2: Using Base64 Input'
        uses: ./
        with:
          keystore-base64: ${{ steps.test_data.outputs.KEYSTORE_BASE64 }}
          keystore-password: 'password123'
          alias-name: 'test_alias'
          alias-password: 'password123'
